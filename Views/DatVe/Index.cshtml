<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đặt Vé</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome (cho icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Google Font (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="~/css/site3.css" rel="stylesheet" />
</head>
<body>

    <!-- Header thông tin phim -->
    <header class="movie-header">
        <div class="container">
            @foreach (var item in ViewBag.dlPhimDaChon)
            {
                <h1>@item.TenPhim</h1>
                <span>@item.ThoiLuong</span>
                <span> phút</span>
                <span>|@string.Join(", ", item.TenTheLoai)</span>    
            }
        </div>
    </header>

    <div class="container-fluid my-4">
        <div class="row">

            <!-- CỘT BÊN TRÁI: CHỌN SUẤT & CHỌN GHẾ -->
            <div class="col-lg-8">
                @{
                    // 1. Ép kiểu ViewBag về Model Phim để code hiểu
                    var phim = ViewBag.dlSuatChieu as TTCN.Models.Phim;

                    // 2. Gom nhóm các suất chiếu theo Cụm Rạp
                    // Logic: Lấy danh sách suất chiếu -> Nhảy sang Phòng -> Nhảy sang Rạp -> Lấy Tên Rạp -> Gom lại
                    var danhSachRap = phim.SuatChieus
                    .GroupBy(sc => sc.MaPhongNavigation.MaCumRapNavigation) // Group theo object CumRap
                    .Select(g => g.Key) // Lấy ra cái Key (chính là CumRap)
                    .ToList();
                }
                <div class="showtime-selector">
                    <div class="filter-header mb-4">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="filter-label">Khu vực</label>
                                <div class="select-wrapper">
                                    <select class="form-select custom-select">
                                        @foreach (var rap in danhSachRap.Select(r => r.ThanhPho).Distinct())
                                        {
                                            <option>@rap</option>
                                        }
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="filter-label">Cụm rạp</label>
                                <div class="select-wrapper">
                                    <select class="form-select custom-select" id="cinema-select" onchange="updateCinemaInfo()">
                                        @foreach (var rap in danhSachRap)
                                        {
                                            <option value="@rap.TenCumRap" data-id="@rap.MaCumRap">@rap.TenCumRap</option>
                                        }
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr class="border-secondary mb-4">
                    <h6>Chọn Ngày</h6>
                    <ul class="nav nav-pills mb-3" id="pills-tab-date" role="tablist">
                        @{
                            int active = 0;
                        }
                        <ul class="nav nav-pills mb-3" id="pills-tab-date" role="tablist">
                            @foreach (var item in ViewBag.dlPhimDaChon)
                            {
                                @foreach (var ngay in @item.CacNgayChieu)
                                {
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link date-btn @(active == 0 ? "active" : "")"
                                                type="button" onclick="filterShowtimeByDate(this, '@ngay.ToString("yyyy-MM-dd")')">
                                            <span class="day-num">@ngay.ToString("dd")</span>
                                            <span class="day-month">/@ngay.ToString("MM")</span>
                                        </button>
                                    </li>
                                    { active++; }
                                }
                            }
                        </ul>
                    </ul>
                    <div class="showtime-list-container">
                        @{
                            var nhomTheoRap = phim.SuatChieus.GroupBy(s => s.MaPhongNavigation.MaCumRapNavigation);
                        }
                            @foreach (var rapGroup in nhomTheoRap)
                            {
                                <div class="cinema-block" data-cinema-id="@rapGroup.Key.MaCumRap">
                                    <div class="cinema-title-row">
                                        <div class="cinema-icon"><i class="fas fa-map-marker-alt"></i></div>
                                        <h5 class="cinema-name">@rapGroup.Key.TenCumRap</h5>
                                    </div>
                                    <div class="rooms-container">
                                        @{
                                            var nhomTheoPhong = rapGroup.GroupBy(s => s.MaPhongNavigation);
                                        }

                                        @foreach (var phongGroup in nhomTheoPhong)
                                        {
                                            <div class="room-row">
                                                <div class="room-label">
                                                    <span>@phongGroup.Key.TenPhong</span>
                                                </div>
                                                <div class="time-slots">
                                                    @foreach (var suat in phongGroup.OrderBy(s => s.GioBatDau))
                                                    {
                                                    <button class="btn-time-slot"
                                                            data-date="@suat.GioBatDau.ToString("yyyy-MM-dd")"
                                                            onclick="selectShowtime(this, '@phongGroup.Key.TenPhong', '@suat.GioBatDau.ToString("HH:mm")', @suat.MaSuat, '@suat.GioBatDau.ToString("dd/MM/yyyy")')">
                                                        @suat.GioBatDau.ToString("HH:mm")
                                                    </button>
                                                    }
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                    </div>
                </div>

                <div class="seat-selection mt-5">
                    <div class="screen-text">MÀN HÌNH</div>
                    <div class="screen"></div>
                    <div id="seat-map-container" class="seat-map mt-4"></div>
                    <div class="legend mt-4">
                        <div class="legend-item"><div class="seat standard"></div><span>Trống</span></div>
                        <div class="legend-item"><div class="seat selected"></div><span>Đang chọn</span></div>
                        <div class="legend-item"><div class="seat occupied"></div><span>Đã bán</span></div>
                    </div>
                </div>
            </div>

            <!-- CỘT BÊN PHẢI: TÓM TẮT GIỎ HÀNG -->
            <div class="col-lg-4">
                <div class="booking-summary">
                    <!-- Thông tin phim -->
                    <div class="mb-3 clearfix">
                        <img src="https://placehold.co/100x150/FF5733/FFFFFF?text=L%E1%BA%ADt+M%E1%BA%B7t+7" alt="Poster Phim" class="summary-poster">
                        <div class="summary-details">
                            <h4 class="mb-1">@ViewBag.TenPhim</h4>
                            <p id="sum-cinema"><strong>Rạp:</strong> Chưa chọn</p>
                            <p id="sum-room"><strong>Phòng:</strong> Chưa chọn</p>
                            <p id="sum-date"><strong>Ngày:</strong> --/--/----</p>
                            <p id="sum-time"><strong>Giờ:</strong> --:--</p>
                        </div>
                    </div>

                    <hr>

                    <!-- Ghế đã chọn -->
                    <div class="mb-3">
                        <h5>Ghế đã chọn (<span id="seat-count">0</span>)</h5>
                        <ul id="selected-seats-list">
                            <!-- JS sẽ thêm ghế vào đây -->
                        </ul>
                    </div>

                    <hr>

                    <!-- Combo -->
                    <div class="mb-3">
                        <h5>Chọn Combo</h5>
                        <select class="form-select" id="combo-select">
                            <option value="0">Không chọn combo</option>
                            <option value="70000">Combo 1 (1 Bắp + 1 Nước) - 70.000đ</option>
                            <option value="120000">Combo 2 (2 Bắp + 2 Nước) - 120.000đ</option>
                        </select>
                    </div>

                    <hr>

                    <!-- Tổng tiền -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">TỔNG CỘNG</h5>
                        <span class="total-price" id="total-price">0đ</span>
                    </div>

                    <!-- Nút Thanh toán -->
                    <button class="btn btn-checkout w-100" data-bs-toggle="modal" data-bs-target="#paymentModal">
                        Thanh Toán
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Thông báo (Thay thế cho alert()) -->
    <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-3 bg-dark text-white">
                <div class="modal-header border-bottom-0">
                    <h5 class="modal-title" id="paymentModalLabel" style="color: var(--brand-red);">Xác nhận Thanh toán</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body fs-5 py-4 text-center">
                    Đây là giao diện mô phỏng.<br>
                    Tổng số tiền của bạn là: <strong id="modal-total-price" class="text-warning">0đ</strong>.<br>
                    Chức năng thanh toán thực tế cần kết nối với backend.
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-checkout" data-bs-dismiss="modal">Xác nhận</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/lib/jquery/dist/jquery.min.js"></script>

    <!-- JavaScript Tùy chỉnh cho đặt vé -->
    <script>
        const seatApiUrl = '@Url.Action("GetGheBySuatChieu", "DatVe")';
        let selectedSeats = [];
        let currentMaSuat = 0;

        function renderSeatMap(maSuat) {
            currentMaSuat = maSuat;
            selectedSeats = [];
            updateCartUI();

            const container = document.getElementById('seat-map-container');
            if (!container) return;

            container.innerHTML = '<div class="text-center text-light"><div class="spinner-border text-danger" role="status"></div><br>Đang tải sơ đồ ghế...</div>';

            $.ajax({
                url: seatApiUrl,
                type: 'GET',
                data: { maSuat: maSuat },
                success: function (data) {
                    container.innerHTML = '';

                    if (!Array.isArray(data) || data.length === 0) {
                        container.innerHTML = '<p class="text-white text-center">Phòng này chưa có sơ đồ ghế.</p>';
                        return;
                    }

                    const rows = {};
                    data.forEach(ghe => {
                        const hang = ghe.hangGhe || ghe.HangGhe;
                        if (!rows[hang]) {
                            rows[hang] = [];
                        }
                        rows[hang].push(ghe);
                    });

                    Object.keys(rows).sort().forEach(hang => {
                        const rowDiv = document.createElement('div');
                        rowDiv.className = 'seat-row mb-2';

                        const labelDiv = document.createElement('div');
                        labelDiv.className = 'row-label';
                        labelDiv.innerText = hang;
                        rowDiv.appendChild(labelDiv);

                        rows[hang]
                            .sort((a, b) => {
                                const nameA = (a.tenGhe || a.TenGhe || '').trim();
                                const nameB = (b.tenGhe || b.TenGhe || '').trim();
                                return nameA.localeCompare(nameB, undefined, { numeric: true, sensitivity: 'base' });
                            })
                            .forEach(ghe => {
                                const seatBtn = document.createElement('button');
                                seatBtn.className = 'seat';
                                const tenGhe = (ghe.tenGhe || ghe.TenGhe || '').trim();
                                seatBtn.innerText = tenGhe;

                                const daDat = ghe.daDat ?? ghe.DaDat;
                                if (daDat) {
                                    seatBtn.classList.add('occupied');
                                    seatBtn.disabled = true;
                                } else {
                                    const loaiGhe = (ghe.loaiGhe || ghe.LoaiGhe || '').toUpperCase();
                                    seatBtn.classList.add(loaiGhe === 'VIP' ? 'vip' : 'standard');
                                    const maGhe = ghe.maGhe ?? ghe.MaGhe;
                                    const giaGhe = ghe.giaGhe ?? ghe.GiaGhe ?? 0;
                                    seatBtn.addEventListener('click', () => toggleSeat(seatBtn, maGhe, tenGhe, Number(giaGhe)));
                                }

                                rowDiv.appendChild(seatBtn);
                            });

                        container.appendChild(rowDiv);
                    });
                },
                error: function () {
                    container.innerHTML = '<p class="text-danger text-center">Lỗi kết nối API.</p>';
                }
            });
        }

        function toggleSeat(btn, maGhe, tenGhe, giaGhe) {
            const index = selectedSeats.findIndex(s => s.id === maGhe);

            if (index === -1) {
                if (selectedSeats.length >= 8) {
                    alert('Bạn chỉ được chọn tối đa 8 ghế.');
                    return;
                }
                selectedSeats.push({ id: maGhe, name: tenGhe, price: giaGhe });
                btn.classList.add('selected');
            } else {
                selectedSeats.splice(index, 1);
                btn.classList.remove('selected');
            }

            updateCartUI();
        }

        function updateCartUI() {
            const listEl = document.getElementById('selected-seats-list');
            const countEl = document.getElementById('seat-count');
            const totalEl = document.getElementById('total-price');
            const modalTotalEl = document.getElementById('modal-total-price');
            const comboSelectEl = document.getElementById('combo-select');
            const btnCheckout = document.querySelector('.btn-checkout');

            if (!listEl || !countEl || !totalEl) return;

            listEl.innerHTML = '';
            let total = 0;

            selectedSeats
                .sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }))
                .forEach(s => {
                    total += s.price;
                    listEl.innerHTML += `
                        <li class="d-flex justify-content-between mb-2 text-white">
                            <span>${s.name}</span>
                            <strong>${Number(s.price).toLocaleString('vi-VN')}đ</strong>
                        </li>`;
                });

            const comboVal = comboSelectEl ? parseInt(comboSelectEl.value, 10) || 0 : 0;
            total += comboVal;

            countEl.innerText = selectedSeats.length;
            const formattedTotal = total.toLocaleString('vi-VN') + 'đ';
            totalEl.innerText = formattedTotal;
            if (modalTotalEl) modalTotalEl.innerText = formattedTotal;
            if (btnCheckout) btnCheckout.disabled = selectedSeats.length === 0;
        }

        function selectShowtime(btnElement, roomName, time, maSuat, ngayChieu) {
            const isAlreadyActive = btnElement.classList.contains('active');
            document.querySelectorAll('.btn-time-slot').forEach(b => b.classList.remove('active'));

            if (isAlreadyActive) {
                resetSummaryInfo();
                clearSeatMap();
                return;
            }

            btnElement.classList.add('active');
            updateBookingInfo(roomName, time, ngayChieu);
            renderSeatMap(maSuat);
        }

        const comboSelect = document.getElementById('combo-select');
        if (comboSelect) {
            comboSelect.addEventListener('change', updateCartUI);
        }

        function updateBookingInfo(roomName, time, ngayChieu) {
            const cinemaSelect = document.getElementById('cinema-select');
            const cinemaName = cinemaSelect ? cinemaSelect.options[cinemaSelect.selectedIndex].text : 'Chưa chọn';

            const cinemaEl = document.getElementById('sum-cinema');
            if (cinemaEl) cinemaEl.innerHTML = `<strong>Rạp:</strong> ${cinemaName}`;

            const roomEl = document.getElementById('sum-room');
            if (roomEl) roomEl.innerHTML = `<strong>Phòng:</strong> ${roomName}`;

            const timeEl = document.getElementById('sum-time');
            if (timeEl) timeEl.innerHTML = `<strong>Giờ:</strong> ${time}`;

            const dateEl = document.getElementById('sum-date');
            if (dateEl) dateEl.innerHTML = `<strong>Ngày:</strong> ${ngayChieu}`;
        }

        function resetSummaryInfo() {
            selectedSeats = [];
            updateCartUI();

            const cinemaSelect = document.getElementById('cinema-select');
            const cinemaName = cinemaSelect ? cinemaSelect.options[cinemaSelect.selectedIndex].text : 'Chưa chọn';

            const cinemaEl = document.getElementById('sum-cinema');
            if (cinemaEl) cinemaEl.innerHTML = `<strong>Rạp:</strong> ${cinemaName}`;

            const roomEl = document.getElementById('sum-room');
            if (roomEl) roomEl.innerHTML = '<strong>Phòng:</strong> Chưa chọn';

            const timeEl = document.getElementById('sum-time');
            if (timeEl) timeEl.innerHTML = '<strong>Giờ:</strong> --:--';

            const dateEl = document.getElementById('sum-date');
            if (dateEl) dateEl.innerHTML = '<strong>Ngày:</strong> --/--/----';
        }

        function clearSeatMap() {
            currentMaSuat = 0;
            const container = document.getElementById('seat-map-container');
            if (!container) return;

            container.innerHTML = `
                <div class="d-flex flex-column align-items-center justify-content-center py-5 text-muted">
                    <i class="fa-regular fa-clock fa-3x mb-3"></i>
                    <h5>Vui lòng chọn suất chiếu để hiển thị ghế</h5>
                </div>
            `;
        }

        function filterShowtimeByDate(btnElement, selectedDate) {
            document.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('active'));
            btnElement.classList.add('active');

            document.querySelectorAll('.btn-time-slot').forEach(slot => {
                const slotDate = slot.getAttribute('data-date');
                slot.style.display = slotDate === selectedDate ? 'inline-block' : 'none';
                slot.classList.remove('active');
            });

            hideEmptySections();
            resetSummaryInfo();
            clearSeatMap();
        }

        function hideEmptySections() {
            document.querySelectorAll('.room-row').forEach(row => {
                const visibleBtns = Array.from(row.querySelectorAll('.btn-time-slot'))
                    .filter(btn => btn.style.display !== 'none');
                row.style.display = visibleBtns.length > 0 ? 'flex' : 'none';
            });

            document.querySelectorAll('.cinema-block').forEach(block => {
                const visibleRooms = Array.from(block.querySelectorAll('.room-row'))
                    .filter(row => row.style.display !== 'none');
                block.style.display = visibleRooms.length > 0 ? 'block' : 'none';
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            clearSeatMap();
            updateCartUI();

            const firstDate = document.querySelector('.date-btn');
            if (firstDate) {
                firstDate.click();
            }
        });
    </script>
</body>
</html>